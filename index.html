<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Burrito Bison: Launcha Libre</title>
  <link rel="stylesheet" href="style.css">
  <script src="UnityProgress.js"></script>
  <script src="burrito-bison-ll.js"></script>
  <script src="kongregate_api.js"></script>
  <style>
    #errorLog {
      position: absolute;
      top: 130px;
      left: 10px;
      width: 300px;
      max-height: 200px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      font-family: Arial, sans-serif;
      font-size: 12px;
      padding: 10px;
      overflow-y: auto;
      z-index: 1000;
      border: 1px solid #fff;
    }
  </style>
</head>
<body>
  <div class="webgl-content">
    <div id="gameContainer" style="width: 100%; height: 100%; margin: auto"></div>
  </div>
  <div id="errorLog"></div>

  <script>
    // Display messages on screen
    function displayMessage(message) {
      const logDiv = document.getElementById("errorLog");
      const timestamp = new Date().toISOString().slice(11, 19); // HH:MM:SS
      const p = document.createElement("p");
      p.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll to latest
    }

    // Track runtime initialization
    var gameInstance = null;
    var isRuntimeInitialized = false;

    // Initialize game after scripts load
    window.addEventListener("DOMContentLoaded", function () {
      try {
        if (typeof UnityLoader === "undefined") {
          displayMessage("UnityLoader not defined. Check if burrito-bison-ll.js is loaded correctly.");
          return;
        }

        // Original UnityLoader instantiation (unchanged)
        gameInstance = UnityLoader.instantiate("gameContainer", "burrito-bison-ll.json", {
          onProgress: UnityProgress,
          Module: {
            onRuntimeInitialized: function () {
              UnityProgress(gameInstance, "complete")
            }
          }
        });

        // Override onRuntimeInitialized for FS setup
        gameInstance.Module.onRuntimeInitialized = function () {
          isRuntimeInitialized = true;
          displayMessage("Unity runtime initialized.");

          // Wait for JS_FileSystem_Mount dependency
          let retries = 10; // Wait up to 10 seconds
          function waitForFSDependency() {
            if (gameInstance.Module.getRunDependencyCount && gameInstance.Module.getRunDependencyCount() > 0) {
              if (retries > 0) {
                retries--;
                displayMessage(`Waiting for FS dependency (${retries} retries left)...`);
                setTimeout(waitForFSDependency, 1000); // Wait 1s
                return;
              }
              displayMessage("FS dependency timeout. IDBFS may not be available.");
              initializeFSFallback();
              return;
            }
            initializeFS();
          }

          function initializeFS() {
            if (!gameInstance.Module.FS) {
              displayMessage("Emscripten FS unavailable. Check build settings or browser restrictions.");
              initializeFSFallback();
              return;
            }
            try {
              // Check if /idbfs is mounted
              if (gameInstance.Module.FS.readdir("/idbfs")) {
                displayMessage("IDBFS mounted at /idbfs.");
                // Ensure syncfs is complete
                gameInstance.Module.FS.syncfs(true, function (err) {
                  if (err) {
                    displayMessage("IDBFS sync failed: " + err);
                    initializeFSFallback();
                  } else {
                    displayMessage("IDBFS synced successfully.");
                  }
                });
              } else {
                displayMessage("IDBFS not mounted. Attempting manual mount.");
                gameInstance.Module.FS.mkdir("/idbfs");
                gameInstance.Module.FS.mount(gameInstance.Module.FS.filesystems.IDBFS, {}, "/idbfs");
                gameInstance.Module.FS.syncfs(true, function (err) {
                  if (err) {
                    displayMessage("Manual IDBFS mount failed: " + err);
                    initializeFSFallback();
                  } else {
                    displayMessage("Manual IDBFS mount and sync successful.");
                  }
                });
              }
            } catch (e) {
              displayMessage("Error initializing FS: " + e.message);
              initializeFSFallback();
            }
          }

          function initializeFSFallback() {
            try {
              if (!gameInstance.Module.FS) {
                displayMessage("No FS available; skipping FS operations.");
                return;
              }
              // Fallback to MEMFS
              gameInstance.Module.FS.mkdir("/idbfs");
              displayMessage("Created /idbfs in MEMFS (non-persistent).");
            } catch (e) {
              displayMessage("Error initializing MEMFS fallback: " + e.message);
            }
          }

          waitForFSDependency();
        };
      } catch (e) {
        displayMessage("Error initializing game: " + e.message);
      }
    });

    // Save localStorage data
    function saveLocalStorage() {
      try {
        const data = JSON.stringify(localStorage, null, 2);
        displayMessage("Saving localStorage: " + data.slice(0, 50) + "...");
        const blob = new Blob([data], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "localStorage.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        return data;
      } catch (e) {
        displayMessage("Error saving localStorage: " + e.message);
        return {};
      }
    }

    // Scrape IndexedDB data
    function scrapeIndexedDB(callback) {
      const data = { indexedDB: {} };
      if (!isRuntimeInitialized || !gameInstance || !gameInstance.Module || !gameInstance.Module.FS) {
        displayMessage("Cannot scrape IndexedDB: Runtime not initialized or FS unavailable.");
        callback(data);
        return;
      }
      try {
        const paths = ["/idbfs/"];
        paths.forEach(path => {
          try {
            const files = gameInstance.Module.FS.readdir(path) || [];
            data.indexedDB[path] = {};
            files.forEach(file => {
              if (file !== "." && file !== "..") {
                try {
                  const filePath = path + file;
                  const stats = gameInstance.Module.FS.stat(filePath);
                  if (!gameInstance.Module.FS.isDir(stats.mode)) {
                    const content = gameInstance.Module.FS.readFile(filePath, { encoding: "utf8" });
                    data.indexedDB[path][file] = content;
                    displayMessage("Scraped file: " + filePath);
                  }
                } catch (e) {
                  displayMessage("Error reading file " + file + " in " + path + ": " + e.message);
                }
              }
            });
          } catch (e) {
            displayMessage("Error reading directory " + path + ": " + e.message);
          }
        });
      } catch (e) {
        displayMessage("Error scraping IndexedDB: " + e.message);
      }
      callback(data);
    }

    // Scrape WebAssembly memory
    function scrapeWasmMemory(callback) {
      const data = { wasmMemory: {} };
      if (!isRuntimeInitialized || !gameInstance || !gameInstance.Module || !gameInstance.Module.HEAPU8) {
        displayMessage("Cannot scrape WebAssembly memory: Runtime not initialized or HEAPU8 unavailable.");
        callback(data);
        return;
      }
      try {
        const startOffset = 0x1000;
        const length = 128;
        const memory = gameInstance.Module.HEAPU8;
        if (startOffset + length <= memory.buffer.byteLength) {
          const memorySlice = new Uint8Array(memory.buffer, startOffset, length);
          data.wasmMemory.rawData = Array.from(memorySlice)
            .map(b => b.toString(16).padStart(2, "0"))
            .join("");
          displayMessage(`Scraped ${length} bytes from WASM memory at offset ${startOffset}`);
        } else {
          displayMessage("Memory offset out of bounds.");
        }
      } catch (e) {
        displayMessage("Error scraping WebAssembly memory: " + e.message);
      }
      callback(data);
    }

    // Scrape Kongregate API data
    function scrapeKongregate(callback) {
      const data = { kongregate: {} };
      if (typeof kongregate !== "undefined" && kongregate.services) {
        try {
          data.kongregate.userId = kongregate.services.getUserId() || "unknown";
          data.kongregate.username = kongregate.services.getUsername() || "unknown";
          kongregate.stats.submit("getStats", 0, function (result) {
            data.kongregate.stats = result || {};
            displayMessage("Scraped Kongregate stats: " + JSON.stringify(result).slice(0, 50) + "...");
            callback(data);
          });
          return;
        } catch (e) {
          displayMessage("Error scraping Kongregate API: " + e.message);
        }
      } else {
        displayMessage("Kongregate API not available. Run on Kongregate domain.");
      }
      callback(data);
    }

    // Scrape all data sources
    function scrapeAllData() {
      if (!isRuntimeInitialized || !gameInstance) {
        displayMessage("Cannot scrape data: Game not initialized.");
        alert("Game is not loaded. Please wait and try again.");
        return;
      }
      const allData = {
        localStorage: JSON.parse(saveLocalStorage() || "{}"),
        timestamp: new Date().toISOString()
      };

      scrapeIndexedDB(function (indexedDBData) {
        allData.indexedDB = indexedDBData.indexedDB;

        scrapeWasmMemory(function (wasmData) {
          allData.wasmMemory = wasmData.wasmMemory;

          scrapeKongregate(function (kongregateData) {
            allData.kongregate = kongregateData.kongregate;

            try {
              const prettyData = JSON.stringify(allData, null, 2);
              displayMessage("All scraped data: " + prettyData.slice(0, 50) + "...");
              const blob = new Blob([prettyData], { type: "application/json" });
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download = `burrito-bison-data-${new Date().toISOString().replace(/[:.]/g, "-")}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            } catch (e) {
              displayMessage("Error saving scraped data: " + e.message);
              alert("Error saving data. See error log on screen.");
            }
          });
        });
      });
    }

    // Add buttons and error log on page load
    window.addEventListener("load", function () {
      try {
        // Save Local Storage button
        const saveButton = document.createElement("button");
        saveButton.innerText = "Save Local Storage";
        saveButton.style.position = "absolute";
        saveButton.style.top = "10px";
        saveButton.style.left = "10px";
        saveButton.style.zIndex = "1000";
        saveButton.onclick = saveLocalStorage;
        document.body.appendChild(saveButton);

        // Scrape All Data button
        const scrapeButton = document.createElement("button");
        scrapeButton.innerText = "Scrape All Data";
        scrapeButton.style.position = "absolute";
        scrapeButton.style.top = "50px";
        scrapeButton.style.left = "10px";
        scrapeButton.style.zIndex = "1000";
        scrapeButton.onclick = scrapeAllData;
        document.body.appendChild(scrapeButton);

        // Initialize error log
        displayMessage("Page loaded. Waiting for game initialization.");
      } catch (e) {
        displayMessage("Error adding buttons: " + e.message);
      }
    });
  </script>
</body>
</html>
